import React, { createContext, useContext, useState, useEffect } from 'react';
import { Language } from '../types';

type Translations = {
    [key in Language]: {
        [key: string]: string | ((args: any) => string);
    };
};

const translations: Translations = {
    es: {
        'sidebar.tasks': 'Tareas Diarias',
        'sidebar.calendar': 'Calendario',
        'sidebar.statistics': 'Estadísticas',
        'sidebar.assistant': 'Asistente',
        'sidebar.install': 'Instalar App',
        'sidebar.settings': 'Configuración',
        'sidebar.synced': 'Sincronizado',
        'sidebar.uploading': 'Subiendo...',
        'sidebar.local_only': 'Solo Local',
        'sidebar.sync_error': 'Error Sync',
        'sidebar.guest': 'Invitado',
        'task.my_day': 'Mi Día',
        'task.no_tasks': 'No hay tareas para hoy.',
        'task.empty_state': '¡Escribe algo abajo o usa tu voz!',
        'task.title_placeholder': 'Título de la tarea...',
        'task.desc_placeholder': 'Descripción detallada...',
        'task.save': 'Guardar',
        'task.cancel': 'Cancelar',
        'task.edit': 'Editar',
        'task.delete': 'Eliminar',
        'task.created': '¡Tarea creada exitosamente!',
        'task.updated': '¡Tarea actualizada!',
        'task.completed': '¡Tarea completada!',
        'task.deleted': 'Tarea eliminada',
        'task.confirm_delete': (title: string) => `¿Estás seguro de que quieres eliminar la tarea "${title}"?`,
        'task.conflict': (args: { time: string, title: string }) => `⚠️ Ya tienes una tarea a las ${args.time}: "${args.title}".\n\n¿Quieres agendar esta también a la misma hora?`,
        'calendar.weekdays': 'DOM_LUN_MAR_MIE_JUE_VIE_SAB',
        'calendar.tasks_count': (count: number) => `${count} Tareas`,
        'assistant.greeting': 'Hola, Buenos Días',
        'assistant.intro': (date: string) => `¿Listo para escuchar tu agenda del ${date}?`,
        'assistant.thinking': 'Pensando...',
        'assistant.speaking': 'Hablando...',
        'assistant.play': 'Reproducir Resumen',
        'assistant.transcript': 'Transcripción',
        'assistant.error': 'Lo siento, encontré un error al revisar tu agenda.',
        'settings.title': 'Cuenta y Nube',
        'settings.configure_db': 'Configurar DB',
        'settings.db_configured': 'Database Configurada',
        'settings.cloud_infra': 'Infraestructura Cloud',
        'settings.sync_info': 'Para sincronizar tus datos, necesitas conectar tu propia base de datos de <strong>Firebase</strong>. Es gratis y tus datos serán 100% privados.',
        'settings.gemini_key': 'Gemini API Key (Para el Micrófono/IA)',
        'settings.save_config': 'Guardar Configuración',
        'settings.hello_user': (name: string) => `¡Hola, ${name}!`,
        'settings.cloud_connected': 'Nube Conectada',
        'settings.access_key': 'Tu Clave de Acceso',
        'settings.disconnect': 'Desconectar Cuenta',
        'settings.create_connect': 'CREAR / CONECTAR',
        'settings.cloud_sync_title': 'Sincronización en la Nube',
        'settings.cloud_sync_desc': 'Usa una "Clave Maestra" para guardar y acceder a tus tareas desde cualquier dispositivo.',
        'settings.name_label': 'Tu Nombre (Para el Avatar)',
        'settings.name_placeholder': 'Ej. Ariel',
        'settings.key_label': 'Tu Clave Maestra',
        'settings.key_placeholder': 'Crea una clave secreta...',
        'settings.key_help': 'Si la clave es nueva, se creará un espacio. Si ya existe, se cargarán los datos.',
        'settings.connecting': 'Conectando...',
        'settings.connect_button': 'Conectar con Clave',
        'settings.export_json': 'GUARDAR JSON',
        'settings.delete_app': 'BORRAR APP',
        'settings.delete_app_confirm': '¿Borrar todas las tareas de este dispositivo? Esta acción es irreversible.',
        'settings.language': 'Idioma / Language',
        'voice.stop': 'Detener Grabación',
        'voice.add_task': 'Agregar Tarea por Voz',
        'voice.listening': 'Escuchando...',
        'voice.processing': 'Procesando...',
        'voice.error_process': 'No se pudo procesar el audio. Verifica tu API Key o la consola.',

        // Statistics
        'stats.title': 'Estadísticas',
        'stats.total_tasks': 'Total Tareas',
        'stats.completed': 'Completadas',
        'stats.pending': 'Pendientes',
        'stats.success_rate': 'Tasa de Éxito',
        'stats.range_day': 'Día',
        'stats.range_week': 'Semana',
        'stats.range_month': 'Mes',
        'stats.range_custom': 'Personalizado',
        'stats.status_title': 'Estatus Actual',
        'stats.level_0': 'Turista del Tiempo',
        'stats.level_0_desc': 'Estás de paseo por tu agenda. Es hora de ponerse serios.',
        'stats.level_1': 'Soñador Estático',
        'stats.level_1_desc': 'Muchas ideas, poca acción. ¡Rompe la inercia hoy mismo!',
        'stats.level_2': 'Procrastinador Novato',
        'stats.level_2_desc': "El 'mañana' es el enemigo. Empieza con una tarea pequeña.",
        'stats.level_3': 'Iniciado del Caos',
        'stats.level_3_desc': 'El desorden está ganando. Organiza tu lista y contraataca.',
        'stats.level_4': 'Caminante Distraído',
        'stats.level_4_desc': 'Has perdido el rumbo. Revisa tus prioridades.',
        'stats.level_5': 'Aprendiz de la Agenda',
        'stats.level_5_desc': 'Vas bien, pero la constancia es la clave.',
        'stats.level_6': 'Guardián del Reloj',
        'stats.level_6_desc': 'Estás protegiendo tu tiempo, pero aún se escapan minutos.',
        'stats.level_7': 'Arquitecto de Rutinas',
        'stats.level_7_desc': 'Los cimientos están puestos. Ahora construye hacia arriba.',
        'stats.level_8': 'Guerrero del Plazo',
        'stats.level_8_desc': 'Cumples, pero con estrés. Intenta terminar antes.',
        'stats.level_9': 'Estratega Diario',
        'stats.level_9_desc': 'Tienes un plan y lo sigues. Solo falta el empujón final.',
        'stats.level_10': 'Conquistador de Metas',
        'stats.level_10_desc': 'Tus objetivos tiemblan cuando te ven llegar.',
        'stats.level_11': 'Señor del Tiempo',
        'stats.level_11_desc': 'Dominas las horas a tu antojo. Eficiencia pura.',
        'stats.level_12': 'Vanguardia de Eficiencia',
        'stats.level_12_desc': 'Estás en la cima. Mantenerse aquí es el reto.',
        'stats.level_13': 'Leyenda Productiva',
        'stats.level_13_desc': 'Tu disciplina es de otro planeta.',
        'stats.level_14': 'La Máquina Absoluta',
        'stats.level_14_desc': 'Perfección pura. ¡Impresionante trabajo!',
    },
    en: {
        'sidebar.tasks': 'Daily Tasks',
        'sidebar.calendar': 'Calendar',
        'sidebar.statistics': 'Statistics',
        'sidebar.assistant': 'Assistant',
        'sidebar.install': 'Install App',
        'sidebar.settings': 'Settings',
        'sidebar.synced': 'Synced',
        'sidebar.uploading': 'Uploading...',
        'sidebar.local_only': 'Local Only',
        'sidebar.sync_error': 'Sync Error',
        'sidebar.guest': 'Guest',
        'task.my_day': 'My Day',
        'task.no_tasks': 'No tasks for today.',
        'task.empty_state': 'Type something below or use your voice!',
        'task.title_placeholder': 'Task title...',
        'task.desc_placeholder': 'Detailed description...',
        'task.save': 'Save',
        'task.cancel': 'Cancel',
        'task.edit': 'Edit',
        'task.delete': 'Delete',
        'task.created': 'Task created successfully!',
        'task.updated': 'Task updated!',
        'task.completed': 'Task completed!',
        'task.deleted': 'Task deleted',
        'task.confirm_delete': (title: string) => `Are you sure you want to delete the task "${title}"?`,
        'task.conflict': (args: { time: string, title: string }) => `⚠️ You already have a task at ${args.time}: "${args.title}".\n\nDo you want to schedule this one at the same time too?`,
        'calendar.weekdays': 'SUN_MON_TUE_WED_THU_FRI_SAT',
        'calendar.tasks_count': (count: number) => `${count} Tasks`,
        'assistant.greeting': 'Hello, Good Morning',
        'assistant.intro': (date: string) => `Ready to hear your agenda for ${date}?`,
        'assistant.thinking': 'Thinking...',
        'assistant.speaking': 'Speaking...',
        'assistant.play': 'Play Summary',
        'assistant.transcript': 'Transcript',
        'assistant.error': 'Sorry, I encountered an error checking your agenda.',
        'settings.title': 'Account & Cloud',
        'settings.configure_db': 'Configure DB',
        'settings.db_configured': 'Database Configured',
        'settings.cloud_infra': 'Cloud Infrastructure',
        'settings.sync_info': 'To sync your data, you need to connect your own <strong>Firebase</strong> database. It is free and your data remains 100% private.',
        'settings.gemini_key': 'Gemini API Key (For Mic/AI)',
        'settings.save_config': 'Save Configuration',
        'settings.hello_user': (name: string) => `Hello, ${name}!`,
        'settings.cloud_connected': 'Cloud Connected',
        'settings.access_key': 'Your Access Key',
        'settings.disconnect': 'Disconnect Account',
        'settings.create_connect': 'CREATE / CONNECT',
        'settings.cloud_sync_title': 'Cloud Sync',
        'settings.cloud_sync_desc': 'Use a "Master Key" to save and access your tasks from any device.',
        'settings.name_label': 'Your Name (For Avatar)',
        'settings.name_placeholder': 'Ex. Ariel',
        'settings.key_label': 'Your Master Key',
        'settings.key_placeholder': 'Create a secret key...',
        'settings.key_help': 'If the key is new, a space will be created. If it exists, data will be loaded.',
        'settings.connecting': 'Connecting...',
        'settings.connect_button': 'Connect with Key',
        'settings.export_json': 'SAVE JSON',
        'settings.delete_app': 'DELETE APP',
        'settings.delete_app_confirm': 'Delete all tasks from this device? This action is irreversible.',
        'settings.language': 'Language / Idioma',
        'voice.stop': 'Stop Recording',
        'voice.add_task': 'Add Task via Voice',
        'voice.listening': 'Listening...',
        'voice.processing': 'Processing...',
        'voice.error_process': 'Could not process audio. Check your API Key or console.',

        // Statistics
        'stats.title': 'Statistics',
        'stats.total_tasks': 'Total Tasks',
        'stats.completed': 'Completed',
        'stats.pending': 'Pending',
        'stats.success_rate': 'Success Rate',
        'stats.range_day': 'Day',
        'stats.range_week': 'Week',
        'stats.range_month': 'Month',
        'stats.range_custom': 'Custom',
        'stats.status_title': 'Current Status',
        'stats.level_0': 'Time Tourist',
        'stats.level_0_desc': 'Just visiting your agenda. Time to get serious.',
        'stats.level_1': 'Static Dreamer',
        'stats.level_1_desc': 'Many ideas, little action. Break the inertia today!',
        'stats.level_2': 'Novice Procrastinator',
        'stats.level_2_desc': "'Tomorrow' is the enemy. Start with a small task.",
        'stats.level_3': 'Chaos Initiate',
        'stats.level_3_desc': 'Disorder is winning. Organize your list and fight back.',
        'stats.level_4': 'Distracted Walker',
        'stats.level_4_desc': 'Lost your way. Review your priorities.',
        'stats.level_5': 'Agenda Apprentice',
        'stats.level_5_desc': 'Doing well, but consistency is key.',
        'stats.level_6': 'Clock Guardian',
        'stats.level_6_desc': 'Protecting your time, but minutes still slip away.',
        'stats.level_7': 'Routine Architect',
        'stats.level_7_desc': 'Foundations are set. Now build upwards.',
        'stats.level_8': 'Deadline Warrior',
        'stats.level_8_desc': 'Delivering, but stressed. Try finishing earlier.',
        'stats.level_9': 'Daily Strategist',
        'stats.level_9_desc': 'You have a plan and follow it. Just needs the final push.',
        'stats.level_10': 'Goal Conqueror',
        'stats.level_10_desc': 'Your goals tremble when they see you coming.',
        'stats.level_11': 'Time Lord',
        'stats.level_11_desc': 'You command the hours at will. Pure efficiency.',
        'stats.level_12': 'Efficiency Vanguard',
        'stats.level_12_desc': 'You are at the top. Staying here is the challenge.',
        'stats.level_13': 'Productive Legend',
        'stats.level_13_desc': 'Your discipline is from another planet.',
        'stats.level_14': 'The Absolute Machine',
        'stats.level_14_desc': 'Pure perfection. Impressive work!',
    },
    id: {
        'sidebar.tasks': 'Tugas Harian',
        'sidebar.calendar': 'Kalender',
        'sidebar.statistics': 'Statistik',
        'sidebar.assistant': 'Asisten',
        'sidebar.install': 'Instal Aplikasi',
        'sidebar.settings': 'Pengaturan',
        'sidebar.synced': 'Tersinkronisasi',
        'sidebar.uploading': 'Mengunggah...',
        'sidebar.local_only': 'Lokal Saja',
        'sidebar.sync_error': 'Kesalahan Sinkronisasi',
        'sidebar.guest': 'Tamu',
        'task.my_day': 'Hari Saya',
        'task.no_tasks': 'Tidak ada tugas untuk hari ini.',
        'task.empty_state': 'Ketik sesuatu di bawah atau gunakan suara Anda!',
        'task.title_placeholder': 'Judul tugas...',
        'task.desc_placeholder': 'Deskripsi rinci...',
        'task.save': 'Simpan',
        'task.cancel': 'Batal',
        'task.edit': 'Ubah',
        'task.delete': 'Hapus',
        'task.created': 'Tugas berhasil dibuat!',
        'task.updated': 'Tugas diperbarui!',
        'task.completed': 'Tugas selesai!',
        'task.deleted': 'Tugas dihapus',
        'task.confirm_delete': (title: string) => `Apakah Anda yakin ingin menghapus tugas "${title}"?`,
        'task.conflict': (args: { time: string, title: string }) => `⚠️ Anda sudah memiliki tugas pada jam ${args.time}: "${args.title}".\n\nApakah Anda ingin menjadwalkan ini pada waktu yang sama juga?`,
        'calendar.weekdays': 'MIN_SEN_SEL_RAB_KAM_JUM_SAB',
        'calendar.tasks_count': (count: number) => `${count} Tugas`,
        'assistant.greeting': 'Halo, Selamat Pagi',
        'assistant.intro': (date: string) => `Siap mendengarkan agenda Anda untuk ${date}?`,
        'assistant.thinking': 'Berpikir...',
        'assistant.speaking': 'Berbicara...',
        'assistant.play': 'Putar Ringkasan',
        'assistant.transcript': 'Transkrip',
        'assistant.error': 'Maaf, saya menemukan kesalahan saat memeriksa agenda Anda.',
        'settings.title': 'Akun & Awan',
        'settings.configure_db': 'Konfigurasi DB',
        'settings.db_configured': 'Database Terkonfigurasi',
        'settings.cloud_infra': 'Infrastruktur Awan',
        'settings.sync_info': 'Untuk menyinkronkan data Anda, Anda perlu menghubungkan basis data <strong>Firebase</strong> Anda sendiri. Ini gratis dan data Anda akan 100% pribadi.',
        'settings.gemini_key': 'Kunci API Gemini (Untuk Mikrofon/AI)',
        'settings.save_config': 'Simpan Konfigurasi',
        'settings.hello_user': (name: string) => `Halo, ${name}!`,
        'settings.cloud_connected': 'Awan Terhubung',
        'settings.access_key': 'Kunci Akses Anda',
        'settings.disconnect': 'Putuskan Akun',
        'settings.create_connect': 'BUAT / HUBUNGKAN',
        'settings.cloud_sync_title': 'Sinkronisasi Awan',
        'settings.cloud_sync_desc': 'Gunakan "Kunci Utama" untuk menyimpan dan mengakses tugas Anda dari perangkat apa pun.',
        'settings.name_label': 'Nama Anda (Untuk Avatar)',
        'settings.name_placeholder': 'Contoh: Ariel',
        'settings.key_label': 'Kunci Utama Anda',
        'settings.key_placeholder': 'Buat kunci rahasia...',
        'settings.key_help': 'Jika kuncinya baru, spasi akan dibuat. Jika sudah ada, data akan dimuat.',
        'settings.connecting': 'Menghubungkan...',
        'settings.connect_button': 'Hubungkan dengan Kunci',
        'settings.export_json': 'SIMPAN JSON',
        'settings.delete_app': 'HAPUS APLIKASI',
        'settings.delete_app_confirm': 'Hapus semua tugas dari perangkat ini? Tindakan ini tidak dapat dibatalkan.',
        'settings.language': 'Bahasa / Language',
        'voice.stop': 'Hentikan Rekaman',
        'voice.add_task': 'Tambah Tugas via Suara',
        'voice.listening': 'Mendengarkan...',
        'voice.processing': 'Memproses...',
        'voice.error_process': 'Tidak dapat memproses audio. Periksa Kunci API atau konsol Anda.',

        // Statistics
        'stats.title': 'Statistik',
        'stats.total_tasks': 'Total Tugas',
        'stats.completed': 'Selesai',
        'stats.pending': 'Tertunda',
        'stats.success_rate': 'Tingkat Keberhasilan',
        'stats.range_day': 'Hari',
        'stats.range_week': 'Minggu',
        'stats.range_month': 'Bulan',
        'stats.range_custom': 'Kustom',
        'stats.status_title': 'Status Saat Ini',
        'stats.level_0': 'Turis Waktu',
        'stats.level_0_desc': 'Hanya berkunjung ke agenda Anda. Saatnya serius.',
        'stats.level_1': 'Pemimpi Statis',
        'stats.level_1_desc': 'Banyak ide, sedikit tindakan. Hancurkan kelembaman hari ini!',
        'stats.level_2': 'Prokrastinator Pemula',
        'stats.level_2_desc': "'Besok' adalah musuh. Mulailah dengan tugas kecil.",
        'stats.level_3': 'Inisiat Kekacauan',
        'stats.level_3_desc': 'Kekacauan menang. Atur daftar Anda dan lawan balik.',
        'stats.level_4': 'Pejalan Terganggu',
        'stats.level_4_desc': 'Tersesat. Dan juga prioritas Anda.',
        'stats.level_5': 'Magang Agenda',
        'stats.level_5_desc': 'Baik, tapi konsistensi adalah kunci.',
        'stats.level_6': 'Penjaga Jam',
        'stats.level_6_desc': 'Melindungi waktu Anda, tetapi menit masih terlewat.',
        'stats.level_7': 'Arsitek Rutinitas',
        'stats.level_7_desc': 'Pondasi sudah diatur. Sekarang bangun ke atas.',
        'stats.level_8': 'Pejuang Tenggat Waktu',
        'stats.level_8_desc': 'Mengirimkan, tapi stres. Coba selesaikan lebih awal.',
        'stats.level_9': 'Ahli Strategi Harian',
        'stats.level_9_desc': 'Anda punya rencana dan mengikutinya. Hanya butuh dorongan terakhir.',
        'stats.level_10': 'Penakluk Tujuan',
        'stats.level_10_desc': 'Tujuan Anda gemetar saat melihat Anda datang.',
        'stats.level_11': 'Penguasa Waktu',
        'stats.level_11_desc': 'Anda menguasai jam sesuka hati. Efisiensi murni.',
        'stats.level_12': 'Vanguard Efisiensi',
        'stats.level_12_desc': 'Anda berada di puncak. Bertahan di sini adalah tantangannya.',
        'stats.level_13': 'Legenda Produktif',
        'stats.level_13_desc': 'Disiplin Anda dari planet lain.',
        'stats.level_14': 'Mesin Mutlak',
        'stats.level_14_desc': 'Kesempurnaan murni. Kerja bagus!',
    }
};

interface LanguageContextProps {
    language: Language;
    setLanguage: (lang: Language) => void;
    t: (key: string, args?: any) => string;
}

const LanguageContext = createContext<LanguageContextProps | undefined>(undefined);

export const LanguageProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
    const [language, setLanguageState] = useState<Language>('es');

    useEffect(() => {
        const savedLang = localStorage.getItem('tm_language') as Language;
        if (savedLang && ['es', 'en', 'id'].includes(savedLang)) {
            setLanguageState(savedLang);
            return;
        }

        const browserLang = navigator.language.split('-')[0];
        if (browserLang === 'en') setLanguageState('en');
        else if (browserLang === 'id') setLanguageState('id');
        else setLanguageState('es');
    }, []);

    const setLanguage = (lang: Language) => {
        setLanguageState(lang);
        localStorage.setItem('tm_language', lang);
    };

    const t = (key: string, args?: any): string => {
        const dict = translations[language] || translations['es'];
        const value = dict[key];

        if (typeof value === 'function') {
            return value(args);
        }
        return value || key;
    };

    return (
        <LanguageContext.Provider value={{ language, setLanguage, t }}>
            {children}
        </LanguageContext.Provider>
    );
};

export const useLanguage = () => {
    const context = useContext(LanguageContext);
    if (!context) {
        throw new Error('useLanguage must be used within a LanguageProvider');
    }
    return context;
};
